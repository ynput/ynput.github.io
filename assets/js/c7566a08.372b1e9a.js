"use strict";(self.webpackChunkayon_docs=self.webpackChunkayon_docs||[]).push([[971],{92256:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>s,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var n=a(87462),i=(a(67294),a(3905));const r={id:"server_api_architecture",title:"Server API Architecture",sidebar_label:"API Architecture"},s=void 0,l={unversionedId:"server_api_architecture",id:"server_api_architecture",title:"Server API Architecture",description:"The backend exposes two APIs and redux is setup to handle both under a single api slice.",source:"@site/docs/server_api_architecture.md",sourceDirName:".",slug:"/server_api_architecture",permalink:"/docs/server_api_architecture",draft:!1,editUrl:"https://github.com/ynput/ayon-documentation/tree/main/website/docs/server_api_architecture.md",tags:[],version:"current",frontMatter:{id:"server_api_architecture",title:"Server API Architecture",sidebar_label:"API Architecture"},sidebar:"Dev",previous:{title:"Introduction",permalink:"/docs/server_introduction"},next:{title:"Theme",permalink:"/docs/server_theme"}},o={},p=[{value:"Code Generation",id:"code-generation",level:2},{value:"Codegen setup",id:"codegen-setup",level:2},{value:"Generating REST API Queries",id:"generating-rest-api-queries",level:2},{value:"Writing and Enhancing RTK Queries",id:"writing-and-enhancing-rtk-queries",level:2},{value:"REST",id:"rest",level:3},{value:"GraphQL",id:"graphql",level:2},{value:"Typescript overrides",id:"typescript-overrides",level:2}],d={toc:p},h="wrapper";function u(e){let{components:t,...r}=e;return(0,i.kt)(h,(0,n.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"The backend exposes two APIs and redux is setup to handle both under a single api slice."),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"There are still a lot of legacy queries that inject instead of enhance. Over time we hope to convert these legacy queries to the new methodology.")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/docs/dev_api_rest"},"REST API")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/docs/dev_api_graphql"},"GraphQL"))),(0,i.kt)("h2",{id:"code-generation"},"Code Generation"),(0,i.kt)("p",null,"We use code generation tools to automatically generate types and queries based off the restAPI and graphql schema."),(0,i.kt)("p",null,"Here is an overview of what is generated (green) and how it is consumed in the app."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"RTK Query oveview",src:a(48543).Z,width:"4280",height:"1120"})),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"RTK Query docs")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://redux-toolkit.js.org/rtk-query/usage/code-generation#openapi"},"RestAPI openAPI codegen")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://the-guild.dev/graphql/codegen/plugins/typescript/typescript-rtk-query"},"Graphql codegen")),(0,i.kt)("h2",{id:"codegen-setup"},"Codegen setup"),(0,i.kt)("p",null,"The generated types are included in the repo but they need to be regenerated every time the API changes or if you write new/update graphql queries."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"yarn generate-rest")," - This needs to be run every time a new query is used in the code base or when the API changes."),(0,i.kt)("li",{parentName:"ol"},"Generate graphql types and queries\na. Set ",(0,i.kt)("inlineCode",{parentName:"li"},"NAME")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"PASSWORD")," values in your ",(0,i.kt)("inlineCode",{parentName:"li"},".env.local")," file. This can be for any user but I recommend using the admin credentials.\nb. ",(0,i.kt)("inlineCode",{parentName:"li"},"yarn generate-token")," - Fetches an auth token and writes to ",(0,i.kt)("inlineCode",{parentName:"li"},".env")," . Used by graphql-codegen to get the schema.\nc. ",(0,i.kt)("inlineCode",{parentName:"li"},"yarn generate-graphql")," - Generates types and rtk queries based on the schema and your ",(0,i.kt)("inlineCode",{parentName:"li"},".graphql")," files."),(0,i.kt)("li",{parentName:"ol"},'Both code gens create RTK queries. These queries can then be "enhanced" with more config and file separation.'),(0,i.kt)("li",{parentName:"ol"},"All GraphQL queries are generated in one ",(0,i.kt)("inlineCode",{parentName:"li"},"graphql.ts")," file. REST API queries are generated in multiple files under ",(0,i.kt)("inlineCode",{parentName:"li"},"src/api/rest/{query_name}.ts"))),(0,i.kt)("h2",{id:"generating-rest-api-queries"},"Generating REST API Queries"),(0,i.kt)("p",null,"Each REST endpoint needs to be explicitly defined inside ",(0,i.kt)("inlineCode",{parentName:"p"},"gen/openapi-config.ts")," and categorized by endpoint type."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},'// Specify the endpoints you want to generate\nconst outputFiles = {\n    bundles: ["listBundles", "checkBundleCompatibility"],\n    folders: ["getFolderHierarchy", "getFolderList"],\n};\n')),(0,i.kt)("p",null,"In the example above, two files will be generated with their associated endpoints: ",(0,i.kt)("inlineCode",{parentName:"p"},"src/api/rest/bundles.ts")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"src/api/rest/folders.ts")),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"To enhance IDE performance, the files are now split. This new approach creates individual files for each query, eliminating the significant performance issues associated with the previous method, which generated a single file for all queries.")),(0,i.kt)("h2",{id:"writing-and-enhancing-rtk-queries"},"Writing and Enhancing RTK Queries"),(0,i.kt)("h3",{id:"rest"},"REST"),(0,i.kt)("p",null,"In this tutorial, we will use the ",(0,i.kt)("strong",{parentName:"p"},"List Bundles")," endpoint as an example."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Locate the Endpoint:")),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Navigate to ",(0,i.kt)("inlineCode",{parentName:"li"},"http://localhost:3000/doc/api")," to find the endpoint name. Look for ",(0,i.kt)("inlineCode",{parentName:"li"},"List Bundles -> listBundles"),".")),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("img",{alt:"Get Project Stats",src:a(75386).Z,width:"1602",height:"520"})),(0,i.kt)("admonition",{parentName:"li",type:"note"},(0,i.kt)("p",{parentName:"admonition"},"The query might already be in use. Perform a global search for ",(0,i.kt)("inlineCode",{parentName:"p"},"listBundles")," to check if it's already set up and can be reused."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Ensure Endpoint Generation:")),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Once you have identified the endpoint, verify that it has been generated. If it hasn't, add the endpoint name (",(0,i.kt)("inlineCode",{parentName:"li"},"listBundles"),") to the ",(0,i.kt)("inlineCode",{parentName:"li"},"outputFiles")," list, following the example provided above."),(0,i.kt)("li",{parentName:"ul"},"Run ",(0,i.kt)("inlineCode",{parentName:"li"},"yarn generate-rest")," again to generate the new query."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Create or Update Service File:")),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Create a new folder in ",(0,i.kt)("inlineCode",{parentName:"li"},"/src/services/")," (e.g., ",(0,i.kt)("inlineCode",{parentName:"li"},"bundles"),") with a new file ",(0,i.kt)("inlineCode",{parentName:"li"},"getBundles.ts"),", or add it to an existing file if appropriate. In this tutorial, we will add it to ",(0,i.kt)("inlineCode",{parentName:"li"},"getBundles.ts"),"."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Import the Correct API:")),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"The generated queries are split into different files. Ensure you import the correct API reference when enhancing these queries. For this example, import the API from ",(0,i.kt)("inlineCode",{parentName:"li"},"src/api/rest/bundles.ts")," as it contains the query.")),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("img",{alt:"Import API",src:a(2892).Z,width:"943",height:"425"})),(0,i.kt)("admonition",{parentName:"li",type:"note"},(0,i.kt)("p",{parentName:"admonition"},'Although the queries have already been "injected" into the api we now "enhance" these queries and then export the enhanced queries as React hooks.'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Enhance the Query:")),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Perform any necessary enhancements to the query.")),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("img",{alt:"Provide tags to endpoints",src:a(98288).Z,width:"1071",height:"516"}))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Export the Enhanced Query:")),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Export the enhanced query as a hook to be consumed in a React component.")))),(0,i.kt)("h2",{id:"graphql"},"GraphQL"),(0,i.kt)("p",null,"Writing graphql queries are similar but involve one extra step at the start to define the queries first."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Create a folder called inside ",(0,i.kt)("inlineCode",{parentName:"li"},"/src/services/{queryFolderName}/gql")," . This is where you will write your graphql queries. Try to match the folder name to the query name and use PascalCase.")),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"We use PascalCase so that it's easier to distinguish between rest and graphql queries.")),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"Writing gql query",src:a(87067).Z,width:"2116",height:"1070"})),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Create a new file called {GetQueryName}.graphql and write your query. Intellisense should provide suggestions and eslint should highlight when a field has an error.\n",(0,i.kt)("img",{alt:"Writing gql query",src:a(28362).Z,width:"1518",height:"662"}))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Once finished ",(0,i.kt)("inlineCode",{parentName:"p"},"run yarn generate-gql"),". This will take your new .graphql file and generate a RTK Query from it whilst also generating the matching types."))),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"You can check this at the bottom of /src/api/graphql.ts ")),(0,i.kt)("ol",{start:4},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Enhance the query similar to how the rest queries are enhanced; except in this case we use API.graphql.enhanceEndpoints .\n",(0,i.kt)("img",{alt:"Enhancing gql query",src:a(85776).Z,width:"2410",height:"1020"}))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Follow the same steps from step 3 of creating rest queries."))),(0,i.kt)("h2",{id:"typescript-overrides"},"Typescript overrides"),(0,i.kt)("p",null,"Often you will want to transform the data inside the query to better structure it using transformResponse . Typescript only knows the full queries response type and so we need to tell it that the query will actually respond with our transformed type."),(0,i.kt)("p",null,"We do this by overriding the result type for the query to match the actual response type. As you can see the the query responds with a boolean and we need to tell typescript this."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"Overriding types",src:a(91269).Z,width:"2470",height:"1506"})),(0,i.kt)("p",null,"Now when we use the query hook we should see the new type we defined as the data. If we hadn't done this then the type would have been the generated query from step 3."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"Using types",src:a(38108).Z,width:"1322",height:"286"})))}u.isMDXComponent=!0},48543:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/api_querying_overview_diagram-c6e714eb1eabfa25309fd894aced55ff.png"},85776:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/enhance_gql-8de523f1c56b70f3e1f06bdb5fded31b.png"},98288:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/enhance_with_provide_tags-355dc8172dd669f9dae7d1eb4f74b9b9.png"},91269:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/overwriting_types-f081ede4a46c0f01f5e10375200942f4.png"},38108:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/query_hook_types-117c13ed4ffcf4c0b138e8cf093b331a.png"},75386:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/rest_api_endpoint_example-ecfb37c16df528e7ae8f1d4e4caaeef8.png"},2892:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/rest_api_import_and_enhance-7224502c980358f48cdf6a6d4474beae.png"},87067:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/writing_gql_query-149e870ca4b8c911a4aa4a06a6c267c3.png"},28362:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/writing_gql_query_2-367e28bbe28116cc91732b11ab73f14b.png"}}]);